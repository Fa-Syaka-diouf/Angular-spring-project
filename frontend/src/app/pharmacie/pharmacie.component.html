<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacap - Section Pharmacies</title>
</head>
<body>
    <!-- Background elements -->
    <div class="background-elements">
        <img src=".\assets\Medical concept_ flat lay, copy, a Health & Medical Photo by Fascinadora.jpeg" alt="logo">
    </div>

    <!-- Header -->
    <header class="header">
        <div class="logo">
            <img src=".\assets\download__46_-removebg-preview.png" alt="icone">Pharmap</div>
        <nav class="nav-links">
            <a href="#accueil" (click)="navigateToHome()">Page accueil</a>
            <a href="#horaire" (click)="navigateToPharmacySearch()">Voir horaire</a>
            <a href="#pharmacie" (click)="navigateToPharmacySearch()">Voir Pharmacie</a>
            <button class="disconnect-btn" (click)="navigateToHome()">déconnexion</button>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-container">
            <h1>Trouvez toutes les meilleures pharmacies ici !</h1>
            
            <ul class="features">
                <li>Cherchez et trouvez tout type de pharmacie</li>
                <li>Allez acheter vos médicaments à n'importe quelle heure, plus d'urgences !</li>
                <li>Accédez aux horaire de toutes les pharmacies disponibles dans notre site !</li>
            </ul>

            <div class="search-section">
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Rechercher pharmacie">
                    <button class="search-btn">Trouver</button>
                </div>
                
                <div class="quick-filters">
                    <button class="filter-btn active">yoff</button>
                    <button class="filter-btn">almadies</button>
                    <button class="filter-btn">medina</button>
                    <button class="filter-btn">point E</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Section pour ajouter une pharmacie -->
    <section class="add-pharmacy-section">
        <button class="add-pharmacy-btn" (click)="openAddPharmacyModal()">
            + Ajouter une pharmacie
        </button>
    </section>

    <!-- Modal avec *ngIf pour contrôler l'affichage -->
    <div class="modal-overlay" 
         *ngIf="isModalOpen" 
         (click)="onModalOverlayClick($event)"
         style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;">
        
        <div class="modal-content" style="background: white; padding: 20px; border-radius: 8px; max-width: 500px; width: 90%;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="modal-title">Ajouter une nouvelle pharmacie</h2>
                <button class="close-btn" (click)="closeAddPharmacyModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            
            <!-- Formulaire réactif fonctionnel -->
            <form [formGroup]="pharmacieForm" (ngSubmit)="onSubmitPharmacie()">
        
        <!-- Nom de la pharmacie -->
        <div class="form-group">
          <label class="form-label" for="nomPharmacie">
            Nom de la pharmacie <span class="required">*</span>
          </label>
          <input 
            type="text" 
            class="form-input" 
            id="nomPharmacie" 
            formControlName="nomPharmacie"
            placeholder="Ex: Pharmacie Centrale"
            [class.error]="isFieldInvalid('nomPharmacie')">
          <div *ngIf="isFieldInvalid('nomPharmacie')" class="error-message">
            {{ getFieldError('nomPharmacie') }}
          </div>
        </div>
        
        <!-- Adresse -->
        <div class="form-group">
          <label class="form-label" for="adressePharmacie">
            Adresse <span class="required">*</span>
          </label>
          <input 
            type="text" 
            class="form-input" 
            id="adressePharmacie" 
            formControlName="adressePharmacie"
            placeholder="Ex: 123 Avenue des Champs-Élysées"
            [class.error]="isFieldInvalid('adressePharmacie')">
          <div *ngIf="isFieldInvalid('adressePharmacie')" class="error-message">
            {{ getFieldError('adressePharmacie') }}
          </div>
        </div>
        
        <!-- Téléphone -->
        <div class="form-group">
          <label class="form-label" for="contactTelephonique">
            Téléphone <span class="required">*</span>
          </label>
          <input 
            type="tel" 
            class="form-input" 
            id="contactTelephonique" 
            formControlName="contactTelephonique"
            placeholder="Ex: +221 33 123 45 67"
            [class.error]="isFieldInvalid('contactTelephonique')">
          <div *ngIf="isFieldInvalid('contactTelephonique')" class="error-message">
            {{ getFieldError('contactTelephonique') }}
          </div>
        </div>
        
        <!-- Gérant -->
        <div class="form-group">
          <label class="form-label" for="idGerant">
            Gérant <span class="required">*</span>
          </label>
          <select 
            class="form-select" 
            id="idGerant" 
            formControlName="idGerant"
            [class.error]="isFieldInvalid('idGerant')">
            <option value="">Sélectionner un gérant</option>
            <option *ngFor="let gerant of gerants" [value]="gerant.idGerant">
              {{ gerant.prenomGerant }} {{ gerant.nomGerant }} ({{ gerant.anneeExperience }} ans d'exp.)
            </option>
          </select>
          <div *ngIf="isFieldInvalid('idGerant')" class="error-message">
            {{ getFieldError('idGerant') }}
          </div>
        </div>
        
        <!-- Coordonnées GPS -->
        <!-- <div class="coordinates-row">
          <div class="form-group">
            <label class="form-label" for="latitude">
              Latitude <span class="required">*</span>
            </label>
            <input 
              type="number" 
              class="form-input" 
              id="latitude" 
              formControlName="latitude"
              step="0.000001"
              placeholder="Ex: 14.6928"
              [class.error]="isFieldInvalid('latitude')">
            <div *ngIf="isFieldInvalid('latitude')" class="error-message">
              {{ getFieldError('latitude') }}
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="longitude">
              Longitude <span class="required">*</span>
            </label>
            <input 
              type="number" 
              class="form-input" 
              id="longitude" 
              formControlName="longitude"
              step="0.000001"
              placeholder="Ex: -17.4467"
              [class.error]="isFieldInvalid('longitude')">
            <div *ngIf="isFieldInvalid('longitude')" class="error-message">
              {{ getFieldError('longitude') }}
            </div>
          </div>
        </div> -->
        
        <!-- Section Disponibilités -->
        <div class="disponibilites-section">
          <div class="section-title">
            Disponibilités <span class="required">*</span>
          </div>
          
          <div formArrayName="disponibilites">
            <div *ngFor="let disponibilite of disponibilitesFormArray.controls; let i = index" 
                 class="disponibilite-item" 
                 [formGroupName]="i">
              
              <div class="disponibilite-header">
                <h4>Disponibilité {{ i + 1 }}</h4>
                <button 
                  type="button" 
                  class="btn btn-danger btn-sm"
                  (click)="removeDisponibilite(i)"
                  [disabled]="disponibilitesFormArray.length <= 1">
                  Supprimer
                </button>
              </div>
              
              <div class="disponibilite-row">
                <div class="form-group">
                  <label class="form-label">Jour <span class="required">*</span></label>
                  <select 
                    class="form-select" 
                    formControlName="jour"
                    [class.error]="isDisponibiliteFieldInvalid(i, 'jour')">
                    <option value="">Sélectionner un jour</option>
                    <option 
                      *ngFor="let jour of getJoursDisponibles(i)" 
                      [value]="jour.value">
                      {{ jour.label }}
                    </option>
                    <!-- Garder l'option sélectionnée même si elle est "utilisée" -->
                    <!-- <option 
                      *ngIf="disponibilite.get('jour')?.value && isJourAlreadySelected(i, disponibilite.get('jour')?.value)"
                      [value]="disponibilite.get('jour')?.value">
                      {{ joursDisponibles.find(j => j.value === disponibilite.get('jour')?.value)?.label }}
                    </option> -->
                  </select>
                  <div *ngIf="isDisponibiliteFieldInvalid(i, 'jour')" class="error-message">
                    {{ getDisponibiliteFieldError(i, 'jour') }}
                  </div>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Heure d'ouverture <span class="required">*</span></label>
                  <input 
                    type="time" 
                    class="form-input" 
                    formControlName="horaireOuverture"
                    [class.error]="isDisponibiliteFieldInvalid(i, 'horaireOuverture')">
                  <div *ngIf="isDisponibiliteFieldInvalid(i, 'horaireOuverture')" class="error-message">
                    {{ getDisponibiliteFieldError(i, 'horaireOuverture') }}
                  </div>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Heure de fermeture <span class="required">*</span></label>
                  <input 
                    type="time" 
                    class="form-input" 
                    formControlName="horaireFermeture"
                    [class.error]="isDisponibiliteFieldInvalid(i, 'horaireFermeture')">
                  <div *ngIf="isDisponibiliteFieldInvalid(i, 'horaireFermeture')" class="error-message">
                    {{ getDisponibiliteFieldError(i, 'horaireFermeture') }}
                  </div>
                </div>
              </div>
              
              <!-- Afficher l'erreur de plage horaire au niveau du groupe -->
              <div *ngIf="disponibilitesFormArray.at(i).errors?.['invalidTimeRange'] && disponibilitesFormArray.at(i).touched" 
                   class="error-message group-error">
                L'heure de fermeture doit être après l'heure d'ouverture
              </div>
            </div>
          </div>
          
          <button 
            type="button" 
            class="btn btn-primary btn-add-disponibilite" 
            (click)="addDisponibilite()">
            + Ajouter une disponibilité
          </button>
          
          <!-- Erreur globale des disponibilités -->
          <div *ngIf="pharmacieForm.get('disponibilites')?.errors?.['atLeastOneRequired'] && pharmacieForm.get('disponibilites')?.touched" 
               class="error-message">
            {{ getFieldError('disponibilites') }}
          </div>
        </div>
        
        <!-- Boutons d'action -->
        <div class="form-actions">
          <button 
            type="button" 
            class="btn btn-cancel" 
            (click)="closeAddPharmacyModal()">
            Annuler
          </button>
          <button 
            type="submit" 
            class="btn btn-submit" 
            [disabled]="pharmacieForm.invalid">
            Ajouter la pharmacie
          </button>
        </div>
        
        <!-- Debug du formulaire (à supprimer en production) -->
        <div class="debug-section" *ngIf="true">
          <strong>Debug Formulaire:</strong><br>
          Formulaire valide: {{ pharmacieForm.valid }}<br>
          Formulaire invalide: {{ pharmacieForm.invalid }}<br>
          Formulaire touché: {{ pharmacieForm.touched }}<br>
          Nombre de disponibilités: {{ disponibilitesFormArray.length }}<br>
          Erreurs principales: {{ pharmacieForm.errors | json }}<br>
          Erreurs disponibilités: {{ pharmacieForm.get('disponibilites')?.errors | json }}
        </div>
      </form>
        </div>
    </div>

    <!-- Pharmacies Section -->
    <section class="pharmacies-section">
        <div class="pharmacies-grid">
            <!-- Utilisation de *ngFor pour itérer sur les pharmacies -->
            <div class="pharmacy-card" 
                 *ngFor="let pharmacie of pharmacies"
                 (click)="onPharmacieClick(pharmacie)" 
                 [attr.data-pharmacy]="pharmacie.nomPharmacie">
                <div class="pharmacy-image">
                    <div class="pharmacy-icon">
                        <img src=".\assets\Architecture_PSD__High_Quality_Free_PSD_Templates_for_Download___Freepik-removebg-preview.png" alt="pharmacie">
                    </div>
                </div>
                <div class="pharmacy-info">
                    <div class="pharmacy-name">{{ pharmacie.nomPharmacie }}</div>
                    <div class="pharmacy-address">{{ pharmacie.adressePharmacie }}</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer Section -->
    <div class="footer-section">
        <div class="footer-container">
            <div class="footer-content">
                <div class="footer-left">
                    <h3 class="footer-title">INSCRIVEZ VOTRE PHARMACIE</h3>
                    <p class="footer-description">
                        Vous êtes propriétaire d'une pharmacie? 
                        Inscrivez la dans notre site à travers notre 
                        <a href="#" class="footer-link" (click)="navigateToFormulaire()">formulaire</a>.
                    </p>
                </div>

                <div class="footer-right">
                    <label class="footer-search-label">Rechercher</label>
                    <div class="footer-search-container">
                        <input type="text" class="footer-search-input" placeholder="Médicaments/pharmacies">
                        <button class="footer-search-btn" (click)="navigateToMedicines()">Rechercher</button>
                    </div>
                </div>
            </div>

            <div class="footer-bottom">
                <p class="footer-copyright">Designed by Fatima</p>
            </div>
        </div>
    </div>


</body>
</html>